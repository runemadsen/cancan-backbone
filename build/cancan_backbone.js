(function() {
  (function() {
    var root;
    root = this;
    root.Ability = Backbone.Model.extend({
      defaults: function() {
        return {
          rules: [],
          aliased_actions: {
            read: ["index", "show"],
            create: ["new"],
            update: ["edit"]
          }
        };
      },
      initialize: function() {
        if (!_.isEmpty(this.get("rules"))) {
          this.set("rules", _.map(this.get("rules"), function(rule) {
            return new Rule(rule);
          }));
        }
      },
      can: function(action, subject) {
        var match;
        match = _.detect(this.relevant_rules(action, subject), function(rule) {
          return rule.matches_conditions(action, subject);
        }, this);
        if (match) {
          return match.get("base_behavior");
        } else {
          return false;
        }
      },
      cannot: function(action, subject) {
        return !this.can(action, subject);
      },
      set_can: function(action, subject, conditions) {
        this.get("rules").push(new Rule({
          base_behavior: true,
          action: action,
          subject: subject,
          conditions: conditions
        }));
      },
      set_cannot: function(action, subject, conditions) {
        this.get("rules").push(new Rule({
          base_behavior: false,
          action: action,
          subject: subject,
          conditions: conditions
        }));
      },
      alias_action: function(from, target) {
        this.validate_target(target);
        if (!_.isArray(this.get("aliased_actions")[target])) {
          this.get("aliased_actions")[target] = [];
        }
        this.get("aliased_actions")[target] = this.get("aliased_actions")[target].concat(from);
      },
      validate_target: function(target) {
        if (_.chain(this.get("aliased_actions")).values().flatten().include(target).value()) {
          throw new Error("You can't specify target (" + target + ") as alias because it is real action name");
        }
      },
      clear_aliased_actions: function() {
        this.set("aliased_actions", {});
      },
      expand_actions: function(actions) {
        return _.chain(actions).map(function(action) {
          if (this.get("aliased_actions")[action]) {
            return [action].concat(this.expand_actions(this.get("aliased_actions")[action]));
          } else {
            return action;
          }
        }, this).flatten().value();
      },
      relevant_rules: function(action, subject) {
        var reversed_rules;
        reversed_rules = this.get("rules").slice(0);
        return _.select(reversed_rules.reverse(), (function(rule) {
          rule.set("expanded_actions", this.expand_actions(rule.get("actions")));
          return rule.is_relevant(action, subject);
        }), this);
      }
    });
    root.Rule = Backbone.Model.extend({
      initialize: function() {
        if (!this.get("actions") && this.get("action")) {
          this.set("actions", _.flatten([this.get("action")]));
        }
        if (!this.get("subjects") && this.get("subject")) {
          this.set("subjects", _.flatten([this.get("subject")]));
        }
        if (!this.get("conditions")) {
          this.set("conditions", {});
        }
      },
      backbone_class: function(sub) {
        if (sub == null) {
          sub = null;
        }
        return sub != null ? sub.backboneClass : void 0;
      },
      is_relevant: function(action, subject) {
        return this.matches_action(action) && this.matches_subject(subject);
      },
      matches_conditions: function(action, subject) {
        if (_.isObject(this.get("conditions")) && !_.isEmpty(this.get("conditions")) && !this.subject_class(subject)) {
          return this.matches_conditions_hash(subject);
        } else {
          if (_.isEmpty(this.get("conditions"))) {
            return true;
          } else {
            return this.get("base_behavior");
          }
        }
      },
      subject_class: function(subject) {
        if (this.backbone_class(subject)) {
          return true;
        } else {
          return false;
        }
      },
      matches_action: function(action) {
        return _.include(this.get("expanded_actions"), "manage") || _.include(this.get("expanded_actions"), action);
      },
      matches_subject: function(subject) {
        return _.include(this.get("subjects"), "all") || _.include(this.get("subjects"), subject) || this.matches_subject_class(subject);
      },
      matches_subject_class: function(subject) {
        return _.any(this.get("subjects"), (function(_this) {
          return function(sub) {
            var sub_class, subject_class;
            sub_class = _this.backbone_class(sub) || _this.backbone_class(sub.constructor);
            subject_class = _this.backbone_class(subject) || _this.backbone_class(subject.constructor);
            return (sub_class && subject_class && sub_class === subject_class) || sub === subject_class || sub_class === subject;
          };
        })(this));
      },
      matches_conditions_hash: function(subject, conditions) {
        if (!conditions) {
          conditions = this.get("conditions");
        }
        if (_.isEmpty(conditions)) {
          return true;
        } else {
          return _.all(conditions, (function(value, name) {
            var attribute;
            attribute = subject[name];
            if (_.isUndefined(attribute)) {
              attribute = subject.get(name);
            }
            if (_.isObject(value) && !_.isArray(value)) {
              if (_.isArray(attribute)) {
                return _.any(attribute, (function(element) {
                  this.matches_conditions_hash(element, value);
                }), this);
              } else {
                return attribute && this.matches_conditions_hash(attribute, value);
              }
            } else if (_.isArray(value)) {
              return _.include(value, attribute) || _.isEqual(value, attribute);
            } else {
              return attribute === value;
            }
          }), this);
        }
      }
    });
  }).call(this);

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FuY2FuX2JhY2tib25lLmpzIiwic291cmNlcyI6WyJjYW5jYW5fYmFja2JvbmUuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQUEsRUFBQSxDQUFDLFNBQUEsR0FBQTtBQUNDLFFBQUEsSUFBQTtBQUFBLElBQUEsSUFBQSxHQUFPLElBQVAsQ0FBQTtBQUFBLElBSUEsSUFBSSxDQUFDLE9BQUwsR0FBZSxRQUFRLENBQUMsS0FBSyxDQUFDLE1BQWYsQ0FDYjtBQUFBLE1BQUEsUUFBQSxFQUFVLFNBQUEsR0FBQTtlQUNSO0FBQUEsVUFBQSxLQUFBLEVBQU8sRUFBUDtBQUFBLFVBQ0EsZUFBQSxFQUNFO0FBQUEsWUFBQSxJQUFBLEVBQU0sQ0FDSixPQURJLEVBRUosTUFGSSxDQUFOO0FBQUEsWUFJQSxNQUFBLEVBQVEsQ0FBQyxLQUFELENBSlI7QUFBQSxZQUtBLE1BQUEsRUFBUSxDQUFDLE1BQUQsQ0FMUjtXQUZGO1VBRFE7TUFBQSxDQUFWO0FBQUEsTUFVQSxVQUFBLEVBQVksU0FBQSxHQUFBO0FBQ1YsUUFBQSxJQUFBLENBQUEsQ0FBUSxDQUFDLE9BQUYsQ0FBVSxJQUFDLENBQUEsR0FBRCxDQUFLLE9BQUwsQ0FBVixDQUFQO0FBQ0UsVUFBQSxJQUFDLENBQUEsR0FBRCxDQUFLLE9BQUwsRUFBYyxDQUFDLENBQUMsR0FBRixDQUFNLElBQUMsQ0FBQSxHQUFELENBQUssT0FBTCxDQUFOLEVBQXFCLFNBQUMsSUFBRCxHQUFBO21CQUM3QixJQUFBLElBQUEsQ0FBSyxJQUFMLEVBRDZCO1VBQUEsQ0FBckIsQ0FBZCxDQUFBLENBREY7U0FEVTtNQUFBLENBVlo7QUFBQSxNQWlCQSxHQUFBLEVBQUssU0FBQyxNQUFELEVBQVMsT0FBVCxHQUFBO0FBQ0gsWUFBQSxLQUFBO0FBQUEsUUFBQSxLQUFBLEdBQVEsQ0FBQyxDQUFDLE1BQUYsQ0FBUyxJQUFDLENBQUEsY0FBRCxDQUFnQixNQUFoQixFQUF3QixPQUF4QixDQUFULEVBQTJDLFNBQUMsSUFB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RixDQUFVLFNBQVYsQ0FBSDt1QkFDRSxDQUFDLENBQUMsR0FBRixDQUFNLFNBQU4sRUFBaUIsQ0FBQyxTQUFDLE9BQUQsR0FBQTtBQUNoQixrQkFBQSxJQUFDLENBQUEsdUJBQUQsQ0FBeUIsT0FBekIsRUFBa0MsS0FBbEMsQ0FBQSxDQURnQjtnQkFBQSxDQUFELENBQWpCLEVBR0csSUFISCxFQURGO2VBQUEsTUFBQTt1QkFNRSxTQUFBLElBQWMsSUFBQyxDQUFBLHVCQUFELENBQXlCLFNBQXpCLEVBQW9DLEtBQXBDLEVBTmhCO2VBREY7YUFBQSxNQVFLLElBQUcsQ0FBQyxDQUFDLE9BQUYsQ0FBVSxLQUFWLENBQUg7cUJBQ0gsQ0FBQyxDQUFDLE9BQUYsQ0FBVSxLQUFWLEVBQWlCLFNBQWpCLENBQUEsSUFBK0IsQ0FBQyxDQUFDLE9BQUYsQ0FBVSxLQUFWLEVBQWlCLFNBQWpCLEVBRDVCO2FBQUEsTUFBQTtxQkFHSCxTQUFBLEtBQWEsTUFIVjthQVhZO1VBQUEsQ0FBRCxDQUFsQixFQWVHLElBZkgsRUFIRjtTQUZ1QjtNQUFBLENBbkN6QjtLQURVLENBaEZaLENBREQ7RUFBQSxDQUFELENBNElDLENBQUMsSUE1SUYsQ0E0SU8sSUE1SVAsQ0FBQSxDQUFBO0FBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIoLT5cbiAgcm9vdCA9IHRoaXNcblxuICAjIEFiaWxpdHlcbiAgIyAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgcm9vdC5BYmlsaXR5ID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kKFxuICAgIGRlZmF1bHRzOiAtPlxuICAgICAgcnVsZXM6IFtdXG4gICAgICBhbGlhc2VkX2FjdGlvbnM6XG4gICAgICAgIHJlYWQ6IFtcbiAgICAgICAgICBcImluZGV4XCJcbiAgICAgICAgICBcInNob3dcIlxuICAgICAgICBdXG4gICAgICAgIGNyZWF0ZTogW1wibmV3XCJdXG4gICAgICAgIHVwZGF0ZTogW1wiZWRpdFwiXVxuXG4gICAgaW5pdGlhbGl6ZTogLT5cbiAgICAgIHVubGVzcyBfLmlzRW1wdHkoQGdldChcInJ1bGVzXCIpKVxuICAgICAgICBAc2V0IFwicnVsZXNcIiwgXy5tYXAoQGdldChcInJ1bGVzXCIpLCAocnVsZSkgLT5cbiAgICAgICAgICBuZXcgUnVsZShydWxlKVxuICAgICAgICApXG4gICAgICByZXR1cm5cblxuICAgIGNhbjogKGFjdGlvbiwgc3ViamVjdCkgLT5cbiAgICAgIG1hdGNoID0gXy5kZXRlY3QoQHJlbGV2YW50X3J1bGVzKGFjdGlvbiwgc3ViamVjdCksIChydWxlKSAtPlxuICAgICAgICBydWxlLm1hdGNoZXNfY29uZGl0aW9ucyBhY3Rpb24sIHN1YmplY3RcbiAgICAgICwgdGhpcylcbiAgICAgIChpZiBtYXRjaCB0aGVuIG1hdGNoLmdldChcImJhc2VfYmVoYXZpb3JcIikgZWxzZSBmYWxzZSlcblxuICAgIGNhbm5vdDogKGFjdGlvbiwgc3ViamVjdCkgLT5cbiAgICAgIG5vdCBAY2FuKGFjdGlvbiwgc3ViamVjdClcblxuICAgIHNldF9jYW46IChhY3Rpb24sIHN1YmplY3QsIGNvbmRpdGlvbnMpIC0+XG4gICAgICBAZ2V0KFwicnVsZXNcIikucHVzaCBuZXcgUnVsZShcbiAgICAgICAgYmFzZV9iZWhhdmlvcjogdHJ1ZVxuICAgICAgICBhY3Rpb246IGFjdGlvblxuICAgICAgICBzdWJqZWN0OiBzdWJqZWN0XG4gICAgICAgIGNvbmRpdGlvbnM6IGNvbmRpdGlvbnNcbiAgICAgIClcbiAgICAgIHJldHVyblxuXG4gICAgc2V0X2Nhbm5vdDogKGFjdGlvbiwgc3ViamVjdCwgY29uZGl0aW9ucykgLT5cbiAgICAgIEBnZXQoXCJydWxlc1wiKS5wdXNoIG5ldyBSdWxlKFxuICAgICAgICBiYXNlX2JlaGF2aW9yOiBmYWxzZVxuICAgICAgICBhY3Rpb246IGFjdGlvblxuICAgICAgICBzdWJqZWN0OiBzdWJqZWN0XG4gICAgICAgIGNvbmRpdGlvbnM6IGNvbmRpdGlvbnNcbiAgICAgIClcbiAgICAgIHJldHVyblxuXG4gICAgYWxpYXNfYWN0aW9uOiAoZnJvbSwgdGFyZ2V0KSAtPlxuICAgICAgQHZhbGlkYXRlX3RhcmdldCB0YXJnZXRcbiAgICAgIEBnZXQoXCJhbGlhc2VkX2FjdGlvbnNcIilbdGFyZ2V0XSA9IFtdICB1bmxlc3MgXy5pc0FycmF5KEBnZXQoXCJhbGlhc2VkX2FjdGlvbnNcIilbdGFyZ2V0XSlcbiAgICAgIEBnZXQoXCJhbGlhc2VkX2FjdGlvbnNcIilbdGFyZ2V0XSA9IEBnZXQoXCJhbGlhc2VkX2FjdGlvbnNcIilbdGFyZ2V0XS5jb25jYXQoZnJvbSlcbiAgICAgIHJldHVyblxuXG4gICAgdmFsaWRhdGVfdGFyZ2V0OiAodGFyZ2V0KSAtPlxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiWW91IGNhbid0IHNwZWNpZnkgdGFyZ2V0IChcIiArIHRhcmdldCArIFwiKSBhcyBhbGlhcyBiZWNhdXNlIGl0IGlzIHJlYWwgYWN0aW9uIG5hbWVcIikgIGlmIF8uY2hhaW4oQGdldChcImFsaWFzZWRfYWN0aW9uc1wiKSkudmFsdWVzKCkuZmxhdHRlbigpLmluY2x1ZGUodGFyZ2V0KS52YWx1ZSgpXG4gICAgICByZXR1cm5cblxuICAgIGNsZWFyX2FsaWFzZWRfYWN0aW9uczogLT5cbiAgICAgIEBzZXQgXCJhbGlhc2VkX2FjdGlvbnNcIiwge31cbiAgICAgIHJldHVyblxuXG4gICAgZXhwYW5kX2FjdGlvbnM6IChhY3Rpb25zKSAtPlxuICAgICAgXy5jaGFpbihhY3Rpb25zKS5tYXAoKGFjdGlvbikgLT5cbiAgICAgICAgaWYgQGdldChcImFsaWFzZWRfYWN0aW9uc1wiKVthY3Rpb25dXG4gICAgICAgICAgW2FjdGlvbl0uY29uY2F0IEBleHBhbmRfYWN0aW9ucyhAZ2V0KFwiYWxpYXNlZF9hY3Rpb25zXCIpW2FjdGlvbl0pXG4gICAgICAgIGVsc2VcbiAgICAgICAgICBhY3Rpb25cbiAgICAgICwgdGhpcykuZmxhdHRlbigpLnZhbHVlKClcblxuICAgIHJlbGV2YW50X3J1bGVzOiAoYWN0aW9uLCBzdWJqZWN0KSAtPlxuICAgICAgcmV2ZXJzZWRfcnVsZXMgPSBAZ2V0KFwicnVsZXNcIikuc2xpY2UoMClcbiAgICAgIF8uc2VsZWN0IHJldmVyc2VkX3J1bGVzLnJldmVyc2UoKSwgKChydWxlKSAtPlxuICAgICAgICBydWxlLnNldCBcImV4cGFuZGVkX2FjdGlvbnNcIiwgQGV4cGFuZF9hY3Rpb25zKHJ1bGUuZ2V0KFwiYWN0aW9uc1wiKSlcbiAgICAgICAgcnVsZS5pc19yZWxldmFudCBhY3Rpb24sIHN1YmplY3RcbiAgICAgICksIHRoaXNcbiAgKVxuICAjIFJ1bGVcbiAgIyAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgcm9vdC5SdWxlID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kKFxuICAgIGluaXRpYWxpemU6IC0+XG4gICAgICBAc2V0IFwiYWN0aW9uc1wiLCBfLmZsYXR0ZW4oW0BnZXQoXCJhY3Rpb25cIildKSAgaWYgbm90IEBnZXQoXCJhY3Rpb25zXCIpIGFuZCBAZ2V0KFwiYWN0aW9uXCIpXG4gICAgICBAc2V0IFwic3ViamVjdHNcIiwgXy5mbGF0dGVuKFtAZ2V0KFwic3ViamVjdFwiKV0pICBpZiBub3QgQGdldChcInN1YmplY3RzXCIpIGFuZCBAZ2V0KFwic3ViamVjdFwiKVxuICAgICAgQHNldCBcImNvbmRpdGlvbnNcIiwge30gIHVubGVzcyBAZ2V0KFwiY29uZGl0aW9uc1wiKVxuICAgICAgcmV0dXJuXG5cbiAgICBiYWNrYm9uZV9jbGFzczogKHN1YiA9IG51bGwpIC0+XG4gICAgICBzdWI/LmJhY2tib25lQ2xhc3NcblxuICAgIGlzX3JlbGV2YW50OiAoYWN0aW9uLCBzdWJqZWN0KSAtPlxuICAgICAgQG1hdGNoZXNfYWN0aW9uKGFjdGlvbikgYW5kIEBtYXRjaGVzX3N1YmplY3Qoc3ViamVjdClcblxuICAgIG1hdGNoZXNfY29uZGl0aW9uczogKGFjdGlvbiwgc3ViamVjdCkgLT5cbiAgICAgIGlmIF8uaXNPYmplY3QoQGdldChcImNvbmRpdGlvbnNcIikpIGFuZCBub3QgXy5pc0VtcHR5KEBnZXQoXCJjb25kaXRpb25zXCIpKSBhbmQgbm90IEBzdWJqZWN0X2NsYXNzKHN1YmplY3QpXG4gICAgICAgIEBtYXRjaGVzX2NvbmRpdGlvbnNfaGFzaCBzdWJqZWN0XG4gICAgICBlbHNlXG4gICAgICAgIChpZiBfLmlzRW1wdHkoQGdldChcImNvbmRpdGlvbnNcIikpIHRoZW4gdHJ1ZSBlbHNlIEBnZXQoXCJiYXNlX2JlaGF2aW9yXCIpKVxuXG4gICAgc3ViamVjdF9jbGFzczogKHN1YmplY3QpIC0+XG4gICAgICAoaWYgQGJhY2tib25lX2NsYXNzKHN1YmplY3QpIHRoZW4gdHJ1ZSBlbHNlIGZhbHNlKVxuXG4gICAgbWF0Y2hlc19hY3Rpb246IChhY3Rpb24pIC0+XG4gICAgICBfLmluY2x1ZGUoQGdldChcImV4cGFuZGVkX2FjdGlvbnNcIiksIFwibWFuYWdlXCIpIG9yIF8uaW5jbHVkZShAZ2V0KFwiZXhwYW5kZWRfYWN0aW9uc1wiKSwgYWN0aW9uKVxuXG4gICAgbWF0Y2hlc19zdWJqZWN0OiAoc3ViamVjdCkgLT5cbiAgICAgIF8uaW5jbHVkZShAZ2V0KFwic3ViamVjdHNcIiksIFwiYWxsXCIpIG9yIF8uaW5jbHVkZShAZ2V0KFwic3ViamVjdHNcIiksIHN1YmplY3QpIG9yIEBtYXRjaGVzX3N1YmplY3RfY2xhc3Moc3ViamVjdClcblxuICAgIG1hdGNoZXNfc3ViamVjdF9jbGFzczogKHN1YmplY3QpIC0+XG4gICAgICAjIGlmIGJvdGggYXJlIGJhY2tib25lIG9iamVjdHMgKGVpdGhlciBjbGFzcyBvciBpbnN0YW5jZSkgaW1wbGVtZW50aW5nIGJhY2tib25lQ2xhc3NcbiAgICAgIF8uYW55IEBnZXQoXCJzdWJqZWN0c1wiKSwgKHN1YikgPT5cbiAgICAgICAgc3ViX2NsYXNzID0gQGJhY2tib25lX2NsYXNzKHN1Yikgb3IgQGJhY2tib25lX2NsYXNzKHN1Yi5jb25zdHJ1Y3RvcilcbiAgICAgICAgc3ViamVjdF9jbGFzcyA9IEBiYWNrYm9uZV9jbGFzcyhzdWJqZWN0KSBvciBAYmFja2JvbmVfY2xhc3Moc3ViamVjdC5jb25zdHJ1Y3RvcilcbiAgICAgICAgKHN1Yl9jbGFzcyBhbmQgc3ViamVjdF9jbGFzcyBhbmQgc3ViX2NsYXNzIGlzIHN1YmplY3RfY2xhc3MpIG9yIHN1YiBpcyBzdWJqZWN0X2NsYXNzIG9yIHN1Yl9jbGFzcyBpcyBzdWJqZWN0XG5cblxuICAgIG1hdGNoZXNfY29uZGl0aW9uc19oYXNoOiAoc3ViamVjdCwgY29uZGl0aW9ucykgLT5cbiAgICAgIGNvbmRpdGlvbnMgPSBAZ2V0KFwiY29uZGl0aW9uc1wiKSAgdW5sZXNzIGNvbmRpdGlvbnNcbiAgICAgIGlmIF8uaXNFbXB0eShjb25kaXRpb25zKVxuICAgICAgICB0cnVlXG4gICAgICBlbHNlXG4gICAgICAgIF8uYWxsIGNvbmRpdGlvbnMsICgodmFsdWUsIG5hbWUpIC0+XG4gICAgICAgICAgYXR0cmlidXRlID0gc3ViamVjdFtuYW1lXVxuICAgICAgICAgIGF0dHJpYnV0ZSA9IHN1YmplY3QuZ2V0KG5hbWUpICBpZiBfLmlzVW5kZWZpbmVkKGF0dHJpYnV0ZSlcbiAgICAgICAgICBpZiBfLmlzT2JqZWN0KHZhbHVlKSBhbmQgbm90IF8uaXNBcnJheSh2YWx1ZSlcbiAgICAgICAgICAgIGlmIF8uaXNBcnJheShhdHRyaWJ1dGUpXG4gICAgICAgICAgICAgIF8uYW55IGF0dHJpYnV0ZSwgKChlbGVtZW50KSAtPlxuICAgICAgICAgICAgICAgIEBtYXRjaGVzX2NvbmRpdGlvbnNfaGFzaCBlbGVtZW50LCB2YWx1ZVxuICAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgICApLCB0aGlzXG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgIGF0dHJpYnV0ZSBhbmQgQG1hdGNoZXNfY29uZGl0aW9uc19oYXNoKGF0dHJpYnV0ZSwgdmFsdWUpXG4gICAgICAgICAgZWxzZSBpZiBfLmlzQXJyYXkodmFsdWUpXG4gICAgICAgICAgICBfLmluY2x1ZGUodmFsdWUsIGF0dHJpYnV0ZSkgb3IgXy5pc0VxdWFsKHZhbHVlLCBhdHRyaWJ1dGUpXG4gICAgICAgICAgZWxzZVxuICAgICAgICAgICAgYXR0cmlidXRlIGlzIHZhbHVlXG4gICAgICAgICksIHRoaXNcbiAgKVxuICByZXR1cm5cbikuY2FsbCB0aGlzIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9